- name: Setup PostgreSQL primary
  hosts: db_primary
  become: true
  vars:
    db_name: db_customers
    db_user: postgres
    db_password: "1234"
    repl_user: repl
    repl_password: "1234"
  pre_tasks:
    - name: Set ips
      set_fact:
        primary_ip: "{{ hostvars[groups['db_primary'][0]].ansible_host | default(groups['db_primary'][0]) }}"
        replica_ip: "{{ hostvars[groups['db_replica'][0]].ansible_host | default(groups['db_replica'][0]) }}"
        bot_ip: "{{ hostvars[groups['bot'][0]].ansible_host | default(groups['bot'][0]) }}"
  tasks:
    - name: Install packages
      ansible.builtin.apt:
        name:
          - postgresql
          - postgresql-contrib
        update_cache: true
        state: present

    - name: Get config file
      ansible.builtin.command: sudo -u postgres psql -tAc "SHOW config_file;"
      register: pg_config_file
      changed_when: false

    - name: Get hba file
      ansible.builtin.command: sudo -u postgres psql -tAc "SHOW hba_file;"
      register: pg_hba_file
      changed_when: false

    - name: Set paths
      set_fact:
        pg_conf_dir: "{{ (pg_config_file.stdout | trim) | dirname }}"
        pg_conf_file: "{{ pg_config_file.stdout | trim }}"
        pg_hba_path: "{{ pg_hba_file.stdout | trim }}"

    - name: Ensure conf.d
      ansible.builtin.file:
        path: "{{ pg_conf_dir }}/conf.d"
        state: directory
        owner: postgres
        group: postgres
        mode: "0755"

    - name: Enable include_dir
      ansible.builtin.lineinfile:
        path: "{{ pg_conf_file }}"
        regexp: "^#?include_dir\\s*=.*"
        line: "include_dir = 'conf.d'"

    - name: Copy repl config
      ansible.builtin.copy:
        src: config-postgresql/repl.conf
        dest: "{{ pg_conf_dir }}/conf.d/repl.conf"
        owner: postgres
        group: postgres
        mode: "0644"

    - name: Template pg_hba
      ansible.builtin.template:
        src: pg_hba.conf
        dest: "{{ pg_hba_path }}"
        owner: postgres
        group: postgres
        mode: "0640"

    - name: Restart postgresql
      ansible.builtin.service:
        name: postgresql
        state: restarted
        enabled: true

    - name: Set password for db user
      ansible.builtin.command: sudo -u postgres psql -v ON_ERROR_STOP=1 -tAc "ALTER USER {{ db_user }} WITH PASSWORD '{{ db_password }}';"

    - name: Check repl role
      ansible.builtin.command: sudo -u postgres psql -tAc "SELECT 1 FROM pg_roles WHERE rolname='{{ repl_user }}'"
      register: repl_exists
      changed_when: false

    - name: Create repl role
      ansible.builtin.command: sudo -u postgres psql -v ON_ERROR_STOP=1 -tAc "CREATE ROLE {{ repl_user }} WITH LOGIN REPLICATION PASSWORD '{{ repl_password }}';"
      when: repl_exists.stdout | trim != "1"

    - name: Check database
      ansible.builtin.command: sudo -u postgres psql -tAc "SELECT 1 FROM pg_database WHERE datname='{{ db_name }}'"
      register: db_exists
      changed_when: false

    - name: Create database
      ansible.builtin.command: sudo -u postgres psql -v ON_ERROR_STOP=1 -tAc "CREATE DATABASE {{ db_name }};"
      when: db_exists.stdout | trim != "1"

    - name: Create tables
      ansible.builtin.command: sudo -u postgres psql -v ON_ERROR_STOP=1 -d {{ db_name }} -tAc "CREATE TABLE IF NOT EXISTS emails (id BIGSERIAL PRIMARY KEY, email TEXT NOT NULL UNIQUE); CREATE TABLE IF NOT EXISTS phone_numbers (id BIGSERIAL PRIMARY KEY, phone TEXT NOT NULL UNIQUE);"

- name: Setup PostgreSQL replica
  hosts: db_replica
  become: true
  vars:
    repl_user: repl
    repl_password: "1234"
  pre_tasks:
    - name: Set ips
      set_fact:
        primary_ip: "{{ hostvars[groups['db_primary'][0]].ansible_host | default(groups['db_primary'][0]) }}"
        replica_ip: "{{ hostvars[groups['db_replica'][0]].ansible_host | default(groups['db_replica'][0]) }}"
        bot_ip: "{{ hostvars[groups['bot'][0]].ansible_host | default(groups['bot'][0]) }}"
  tasks:
    - name: Install packages
      ansible.builtin.apt:
        name:
          - postgresql
          - postgresql-contrib
        update_cache: true
        state: present

    - name: Get config file
      ansible.builtin.command: sudo -u postgres psql -tAc "SHOW config_file;"
      register: pg_config_file
      changed_when: false

    - name: Get hba file
      ansible.builtin.command: sudo -u postgres psql -tAc "SHOW hba_file;"
      register: pg_hba_file
      changed_when: false

    - name: Get data dir
      ansible.builtin.command: sudo -u postgres psql -tAc "SHOW data_directory;"
      register: pg_data_dir
      changed_when: false

    - name: Set paths
      set_fact:
        pg_conf_dir: "{{ (pg_config_file.stdout | trim) | dirname }}"
        pg_conf_file: "{{ pg_config_file.stdout | trim }}"
        pg_hba_path: "{{ pg_hba_file.stdout | trim }}"
        pg_data_path: "{{ pg_data_dir.stdout | trim }}"

    - name: Ensure conf.d
      ansible.builtin.file:
        path: "{{ pg_conf_dir }}/conf.d"
        state: directory
        owner: postgres
        group: postgres
        mode: "0755"

    - name: Enable include_dir
      ansible.builtin.lineinfile:
        path: "{{ pg_conf_file }}"
        regexp: "^#?include_dir\\s*=.*"
        line: "include_dir = 'conf.d'"

    - name: Copy repl config
      ansible.builtin.copy:
        src: config-postgresql/repl.conf
        dest: "{{ pg_conf_dir }}/conf.d/repl.conf"
        owner: postgres
        group: postgres
        mode: "0644"

    - name: Template pg_hba
      ansible.builtin.template:
        src: pg_hba.conf
        dest: "{{ pg_hba_path }}"
        owner: postgres
        group: postgres
        mode: "0640"

    - name: Restart postgresql
      ansible.builtin.service:
        name: postgresql
        state: restarted
        enabled: true

    - name: Stop postgresql
      ansible.builtin.service:
        name: postgresql
        state: stopped

    - name: Install pgpass
      ansible.builtin.template:
        src: pgpass
        dest: /var/lib/postgresql/.pgpass
        owner: postgres
        group: postgres
        mode: "0600"

    - name: Remove old data
      ansible.builtin.command: bash -c "rm -rf {{ pg_data_path }}/*"
      changed_when: true

    - name: Ensure ownership
      ansible.builtin.file:
        path: "{{ pg_data_path }}"
        state: directory
        owner: postgres
        group: postgres
        mode: "0700"

    - name: Basebackup
      ansible.builtin.command: sudo -u postgres pg_basebackup -h {{ primary_ip }} -D {{ pg_data_path }} -U {{ repl_user }} -Fp -Xs -P -R
      environment:
        PGPASSFILE: /var/lib/postgresql/.pgpass

    - name: Fix permissions
      ansible.builtin.file:
        path: "{{ pg_data_path }}"
        state: directory
        owner: postgres
        group: postgres
        mode: "0700"

    - name: Start postgresql
      ansible.builtin.service:
        name: postgresql
        state: started
        enabled: true

- name: Deploy bot
  hosts: bot
  become: true
  vars:
    repo_url: ""
    repo_branch: docker
    bot_token: ""
    db_name: db_customers
    db_user: postgres
    db_password: "1234"
    bot_root: /opt/devops_bot
    bot_src: /opt/devops_bot/src
    bot_venv: /opt/devops_bot/venv
  pre_tasks:
    - name: Set primary ip
      set_fact:
        primary_ip: "{{ hostvars[groups['db_primary'][0]].ansible_host | default(groups['db_primary'][0]) }}"

    - name: Require repo_url
      ansible.builtin.fail:
        msg: repo_url is required
      when: repo_url | length == 0

    - name: Require bot_token
      ansible.builtin.fail:
        msg: bot_token is required
      when: bot_token | length == 0
  tasks:
    - name: Install packages
      ansible.builtin.apt:
        name:
          - git
          - python3
          - python3-venv
          - python3-pip
        update_cache: true
        state: present

    - name: Ensure dirs
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - "{{ bot_root }}"
        - "{{ bot_src }}"

    - name: Clone repo
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ bot_src }}"
        version: "{{ repo_branch }}"
        force: true

    - name: Create venv
      ansible.builtin.command: python3 -m venv {{ bot_venv }}
      args:
        creates: "{{ bot_venv }}/bin/python"

    - name: Install requirements
      ansible.builtin.command: "{{ bot_venv }}/bin/pip install --no-cache-dir -r {{ bot_src }}/bot/requirements.txt"

    - name: Install systemd unit
      ansible.builtin.copy:
        dest: /etc/systemd/system/tg-bot.service
        mode: "0644"
        content: |
          [Unit]
          Description=tg-bot
          After=network-online.target
          Wants=network-online.target

          [Service]
          Type=simple
          WorkingDirectory={{ bot_src }}/bot
          Environment=TOKEN={{ bot_token }}
          Environment=DB_HOST={{ primary_ip }}
          Environment=DB_PORT=5432
          Environment=DB_NAME={{ db_name }}
          Environment=DB_USER={{ db_user }}
          Environment=DB_PASSWORD={{ db_password }}
          ExecStart={{ bot_venv }}/bin/python {{ bot_src }}/bot/bot.py
          Restart=always
          RestartSec=3

          [Install]
          WantedBy=multi-user.target

    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: Enable and start bot
      ansible.builtin.systemd:
        name: tg-bot
        enabled: true
        state: started
